---
import MenuItem from '../components/MenuItem.astro'
import {getCollection} from 'astro:content'
import type {CollectionEntry} from 'astro:content'
import type {MenuItemProps} from '../types/MenuItemProps'
import {getImage} from 'astro:assets'
import type {ImageMetadata} from 'astro'

import '../styles/global.css'

interface Props {
  title: string
  previewImageUrl: string
  description: string
}

function compareMenuItemData(a: CollectionEntry<'sculptures'>, b: CollectionEntry<'sculptures'>): number {
  if (a.data.impressivenessScore > b.data.impressivenessScore) {
    return -1
  }

  if (a.data.impressivenessScore < b.data.impressivenessScore) {
    return 1
  }

  return 0
}

function isPathActive(expectedPath: string, currentPath: string): boolean {
  const regex = new RegExp(`^${expectedPath}\/?$`)
  return regex.test(currentPath)
}

function createMenuItems(sculptures: CollectionEntry<'sculptures'>[], currentPath: string): MenuItemProps[] {
  const menuItems: MenuItemProps[] = []

  menuItems.push({
    name: 'Home',
    url: '/',
    isActive: isPathActive('/', currentPath),
  })

  const sculptureMenuItems: MenuItemProps[] = sculptures
    .sort(compareMenuItemData)
    .map(item => ({
      name: item.data.title,
      url: `/${item.id}/`,
      isActive: isPathActive(`/${item.id}`, currentPath),
    }))

  menuItems.push(...sculptureMenuItems)

  menuItems.push({
    name: 'Over',
    url: '/about/',
    isActive: isPathActive('/about', currentPath),
  })

  menuItems.push({
    name: 'Contact',
    url: '/contact/',
    isActive: isPathActive('/contact', currentPath),
  })

  return menuItems
}

const sculptureCollection = await getCollection('sculptures')

const {title, description, previewImageUrl} = Astro.props

const menuItems = createMenuItems(sculptureCollection, Astro.url.pathname)

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/**/*.webp')

const previewImageResult = await getImage({src: images[previewImageUrl](), format: 'webp'})
---

<!doctype html>
<html lang="nl">
<head>
    <title>{title} - the oak tells</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <link rel="sitemap" href="/sitemap-index.xml"/>
    <link rel="canonical" href={Astro.url}>
    <meta property="og:title" content={`${title} - the oak tells`}>
    <meta property="og:url" content={Astro.url}>
    <meta name="description" property="og:description"
          content={description}/>
    <meta property="og:image"
          content={new URL(previewImageResult.src, Astro.site)}>
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:image"
          content={new URL(previewImageResult.src, Astro.site)}>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;1,400;1,700&family=Questrial&display=swap"
          rel="stylesheet">
    <meta name="generator" content={Astro.generator}/>
    <script is:inline src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.min.css"
          integrity="sha512-bjwk1c6AQQOi6kaFhKNrqoCNLHpq8PT+I42jY/il3r5Ho/Wd+QUT6Pf3WGZa/BwSdRSIjVGBsPtPPo95gt/SLg=="
          crossorigin="anonymous" referrerpolicy="no-referrer" rel="stylesheet"/>
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.min.js"
            integrity="sha512-cWEytOR8S4v/Sd3G5P1Yb7NbYgF1YAUzlg1/XpDuouZVo3FEiMXbeWh4zewcYu/sXYQR5PgYLRbhf18X/0vpRg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body class="box-border bg-secondary text-primary-dark flex min-h-dvh">
<!--<div class="jw-mobile-menu jw-mobile-is-text js-mobile-menu">-->
<!--    <span class="jw-mobile-menu__button jw-mobile-menu__button&#45;&#45;dummy"></span>-->
<!--    <div class="jw-mobile-header jw-mobile-header&#45;&#45;text">-->
<!--        <a class="jw-mobile-header-content" href="/">-->
<!--            <div class="jw-mobile-text">-->
<!--                <span style="color: #65c77a; font-size: 120%;">the oak tells</span>-->
<!--            </div>-->
<!--        </a>-->
<!--    </div>-->
<!--    <button id="mobile-menu-toggle-button" type="button" class="jw-mobile-menu__button jw-mobile-toggle"-->
<!--            aria-label="Open / sluit menu">-->
<!--        <span class="jw-icon-burger"></span>-->
<!--    </button>-->
<!--</div>-->
<!--<nav class="menu jw-menu-clone jw-menu-collapse">-->
<!--    <ul class="jw-menu jw-menu-vertical">-->
<!--      {-->
<!--        menuItems.map(menuItem =>-->
<!--                <MenuItem {...menuItem}/>)-->
<!--      }-->
<!--    </ul>-->
<!--</nav>-->
<section class="flex flex-row-reverse w-full">
    <article class="w-3/5 p-10">
        <section class="max-w-145">
            <main class="mb-16 space-y-4">
                <slot/>
            </main>
            <footer class="bg-secondary-dark px-5 py-6 rounded-sm">
                Â© 2009 - {(new Date()).getFullYear()} the oak tells
            </footer>
        </section>
    </article>
    <article class="w-2/5 min-w-110 bg-primary flex flex-col items-end">
        <section class="ml-20 pl-10 pt-18 pr-8">
            <a class:list={['text-6xl',
              'tracking-tighter',
              'text-accent',
              'font-bold',
              'mb-8',
              'block',
              'font-serif']}
               href="/">the oak tells</a>
            <nav>
                <ul>
                  {
                    menuItems.map(({name, url, isActive}) =>
                            <MenuItem name={name} url={url} isActive={isActive}/>)
                  }
                </ul>
            </nav>
        </section>
    </article>
</section>
</body>
</html>
<script is:inline defer src="/index.js"/>
